<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PerformanceEndpoint.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.jboss.examples.ticketmonster.rest</a> &gt; <span class="el_source">PerformanceEndpoint.java</span></div><h1>PerformanceEndpoint.java</h1><pre class="source lang-java linenums">package org.jboss.examples.ticketmonster.rest;

import java.util.ArrayList;
import java.util.List;

import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.NoResultException;
import javax.persistence.OptimisticLockException;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import javax.ws.rs.Consumes;
import javax.ws.rs.DELETE;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;
import javax.ws.rs.core.UriBuilder;

import org.jboss.examples.ticketmonster.rest.dto.PerformanceDTO;
import org.jboss.examples.ticketmonster.model.Booking;
import org.jboss.examples.ticketmonster.model.Performance;
import org.jboss.examples.ticketmonster.model.SectionAllocation;
import org.jboss.examples.ticketmonster.model.Show;

/**
 * 
 */
@Stateless
@Path(&quot;/performances&quot;)
<span class="fc" id="L40">public class PerformanceEndpoint</span>
{
   @PersistenceContext(unitName = &quot;primary&quot;)
   private EntityManager em;

   @POST
   @Consumes(&quot;application/json&quot;)
   public Response create(PerformanceDTO dto)
   {
<span class="nc" id="L49">      Performance entity = dto.fromDTO(null, em);</span>
<span class="nc" id="L50">      em.persist(entity);</span>
<span class="nc" id="L51">      return Response.created(UriBuilder.fromResource(PerformanceEndpoint.class).path(String.valueOf(entity.getId())).build()).build();</span>
   }

   @DELETE
   @Path(&quot;/{id:[0-9][0-9]*}&quot;)
   public Response deleteById(@PathParam(&quot;id&quot;) Long id)
   {
<span class="nc" id="L58">      Performance entity = em.find(Performance.class, id);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">      if (entity == null)</span>
      {
<span class="nc" id="L61">         return Response.status(Status.NOT_FOUND).build();</span>
      }
<span class="nc" id="L63">      Show show = entity.getShow();</span>
<span class="nc" id="L64">      show.getPerformances().remove(entity);</span>
<span class="nc" id="L65">      entity.setShow(null);</span>
<span class="nc" id="L66">      this.em.merge(show);</span>
<span class="nc" id="L67">      List&lt;SectionAllocation&gt; sectionAllocations = findSectionAllocationsByPerformance(entity);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">      for(SectionAllocation sectionAllocation: sectionAllocations) {</span>
<span class="nc" id="L69">         this.em.remove(sectionAllocation);</span>
<span class="nc" id="L70">      }</span>
<span class="nc" id="L71">      List&lt;Booking&gt; bookings = findBookingsByPerformance(entity);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">      for(Booking booking: bookings) {</span>
<span class="nc" id="L73">         this.em.remove(booking);</span>
<span class="nc" id="L74">      }</span>
<span class="nc" id="L75">      em.remove(entity);</span>
<span class="nc" id="L76">      return Response.noContent().build();</span>
   }

   @GET
   @Path(&quot;/{id:[0-9][0-9]*}&quot;)
   @Produces(&quot;application/json&quot;)
   public Response findById(@PathParam(&quot;id&quot;) Long id)
   {
<span class="fc" id="L84">      TypedQuery&lt;Performance&gt; findByIdQuery = em.createQuery(&quot;SELECT DISTINCT p FROM Performance p LEFT JOIN FETCH p.show WHERE p.id = :entityId ORDER BY p.id&quot;, Performance.class);</span>
<span class="fc" id="L85">      findByIdQuery.setParameter(&quot;entityId&quot;, id);</span>
      Performance entity;
      try
      {
<span class="fc" id="L89">         entity = findByIdQuery.getSingleResult();</span>
      }
<span class="nc" id="L91">      catch (NoResultException nre)</span>
      {
<span class="nc" id="L93">         entity = null;</span>
<span class="fc" id="L94">      }</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">      if (entity == null)</span>
      {
<span class="nc" id="L97">         return Response.status(Status.NOT_FOUND).build();</span>
      }
<span class="fc" id="L99">      PerformanceDTO dto = new PerformanceDTO(entity);</span>
<span class="fc" id="L100">      return Response.ok(dto).build();</span>
   }

   @GET
   @Produces(&quot;application/json&quot;)
   public List&lt;PerformanceDTO&gt; listAll(@QueryParam(&quot;start&quot;) Integer startPosition, @QueryParam(&quot;max&quot;) Integer maxResult)
   {
<span class="fc" id="L107">      TypedQuery&lt;Performance&gt; findAllQuery = em.createQuery(&quot;SELECT DISTINCT p FROM Performance p LEFT JOIN FETCH p.show ORDER BY p.id&quot;, Performance.class);</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">      if (startPosition != null)</span>
      {
<span class="nc" id="L110">         findAllQuery.setFirstResult(startPosition);</span>
      }
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">      if (maxResult != null)</span>
      {
<span class="nc" id="L114">         findAllQuery.setMaxResults(maxResult);</span>
      }
<span class="fc" id="L116">      final List&lt;Performance&gt; searchResults = findAllQuery.getResultList();</span>
<span class="fc" id="L117">      final List&lt;PerformanceDTO&gt; results = new ArrayList&lt;PerformanceDTO&gt;();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">      for (Performance searchResult : searchResults)</span>
      {
<span class="fc" id="L120">         PerformanceDTO dto = new PerformanceDTO(searchResult);</span>
<span class="fc" id="L121">         results.add(dto);</span>
<span class="fc" id="L122">      }</span>
<span class="fc" id="L123">      return results;</span>
   }

   @PUT
   @Path(&quot;/{id:[0-9][0-9]*}&quot;)
   @Consumes(&quot;application/json&quot;)
   public Response update(@PathParam(&quot;id&quot;) Long id, PerformanceDTO dto)
   {
<span class="nc" id="L131">      TypedQuery&lt;Performance&gt; findByIdQuery = em.createQuery(&quot;SELECT DISTINCT p FROM Performance p LEFT JOIN FETCH p.show WHERE p.id = :entityId ORDER BY p.id&quot;, Performance.class);</span>
<span class="nc" id="L132">      findByIdQuery.setParameter(&quot;entityId&quot;, id);</span>
      Performance entity;
      try
      {
<span class="nc" id="L136">         entity = findByIdQuery.getSingleResult();</span>
      }
<span class="nc" id="L138">      catch (NoResultException nre)</span>
      {
<span class="nc" id="L140">         entity = null;</span>
<span class="nc" id="L141">      }</span>
<span class="nc" id="L142">      entity = dto.fromDTO(entity, em);</span>
      try
      {
<span class="nc" id="L145">         entity = em.merge(entity);</span>
      }
<span class="nc" id="L147">      catch (OptimisticLockException e)</span>
      {
<span class="nc" id="L149">         return Response.status(Response.Status.CONFLICT).entity(e.getEntity()).build();</span>
<span class="nc" id="L150">      }</span>
<span class="nc" id="L151">      return Response.noContent().build();</span>
   }

   public List&lt;SectionAllocation&gt; findSectionAllocationsByPerformance(Performance performance)
   {
<span class="nc" id="L156">      CriteriaQuery&lt;SectionAllocation&gt; criteria = this.em</span>
<span class="nc" id="L157">            .getCriteriaBuilder().createQuery(SectionAllocation.class);</span>
<span class="nc" id="L158">      Root&lt;SectionAllocation&gt; from = criteria.from(SectionAllocation.class);</span>
<span class="nc" id="L159">      CriteriaBuilder builder = this.em.getCriteriaBuilder();</span>
<span class="nc" id="L160">      Predicate performanceIsSame = builder.equal(from.get(&quot;performance&quot;), performance);</span>
<span class="nc" id="L161">      return this.em.createQuery(</span>
<span class="nc" id="L162">            criteria.select(from).where(performanceIsSame)).getResultList();</span>
   }

   public List&lt;Booking&gt; findBookingsByPerformance(Performance performance)
   {
<span class="nc" id="L167">      CriteriaQuery&lt;Booking&gt; criteria = this.em</span>
<span class="nc" id="L168">            .getCriteriaBuilder().createQuery(Booking.class);</span>
<span class="nc" id="L169">      Root&lt;Booking&gt; from = criteria.from(Booking.class);</span>
<span class="nc" id="L170">      CriteriaBuilder builder = this.em.getCriteriaBuilder();</span>
<span class="nc" id="L171">      Predicate performanceIsSame = builder.equal(from.get(&quot;performance&quot;), performance);</span>
<span class="nc" id="L172">      return this.em.createQuery(</span>
<span class="nc" id="L173">            criteria.select(from).where(performanceIsSame)).getResultList();</span>
   }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>